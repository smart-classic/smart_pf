<!DOCTYPE html>
<html>
<head>
<title>SMArt Container Example</title>
    <STYLE TYPE="text/css" MEDIA=screen>
      html {height: 100%; width: 100%;
      border: 0px;
      padding: 0px;
      margin: 0px;}
      body {height: 100%; width: 100%;
      border: 0px;
      padding: 0px;
      margin: 0px;}
    IFRAME.oactivity {
      border: 0px;
      padding: 0px;
      margin: 0px;
      height: 99%;
      width: 100%; 
      box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box;
      padding-bottom: 1em;
      display: inline-block;
    }   
	
    </STYLE>
</head>
<body>

<script src="http://sandbox.smartplatforms.org/static/smart_ui_server/resources/class.js"></script>
<script src="http://sandbox.smartplatforms.org/static/smart_ui_server/resources/smart-api-container.js"></script>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script src="http://sample-apps.smartplatforms.org/framework/smart/scripts/jschannel.js"></script>
<script>
window.resizeTo(800,700);
var callbacks = [];
var doMessage = function(m){
        if (m.PluginAttached) {
             SMART.start_activity("main", $_GET['app']);
             return;
        }
	if (m.id !== undefined) {
	     callbacks[m.id](m.response);
	}
};

function getQueryParams(qs) {
    qs = qs.split("+").join(" ");
    var params = {};
    var tokens,
        re = /[?&]?([^=]+)=([^&]*)/g;

    while (tokens = re.exec(qs)) {
        params[decodeURIComponent(tokens[1])]
            = decodeURIComponent(tokens[2]);
    }

    return params;
}

var $_GET = getQueryParams(document.location.search);
var patient = $_GET["patient"];

var SMART_HELPER = {};
SMART_HELPER.handle_record_info = function(app, callback) {
    callbacks.push(callback);		
    postToPlugin ({id: callbacks.length-1, RecordInfo: {patient: patient}});	
};


app_lookup = {
  'medlist@apps.smart.org' : 'http://sample-apps.smartplatforms.org/framework/med_list/bootstrap.html',
  'smart-problems@apps.smart.org' :'http://sample-apps.smartplatforms.org/framework/problem_list/bootstrap.html',
  'got-statins@apps.smart.org' : 'http://sample-apps.smartplatforms.org/framework/got_statins/bootstrap.html'
};

SMART_HELPER.handle_start_activity = function(activity, callback) {

  if (activity.name !== "main")
  {
    alert("Sample start_activity only known how to launch main activity.");
  }

  if (activity.app === null)
  {
     alert("Sample start_activity requires that you specify an app.");
  }

  var url = app_lookup[activity.app];
  var frame_id = "app_content_iframe_"+randomUUID();
  var frame = $('<iframe class="oactivity" src="'+url+'" id="'+frame_id+'"> </iframe><br>')
  $('body').append(frame);
  callback(frame[0]);

};


SMART_HELPER.handle_api = function(activity, api_call, callback)
{
      if (api_call.method=="GET" && api_call.func.match(/^\/capabilities\/$/))
      {
        callback("<?xml version='1.0'?>\
                   <rdf:RDF xmlns:rdf='http://www.w3.org/1999/02/22-rdf-syntax-ns#' >\
                  </rdf:RDF>");
      }
      else if (api_call.method=="GET" && api_call.func.match(/^.*\/medications\/$/))
      {
		callbacks.push(callback);		
		postToPlugin ({id: callbacks.length-1, message: api_call});
      }
     else
        alert("Function " + api_call.func + " not implemented yet.");

};

SMART = new SMART_CONTAINER(SMART_HELPER);

</script>

</body>
</html>

